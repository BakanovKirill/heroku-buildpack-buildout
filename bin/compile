#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -eo pipefail

# Prepend proper path for virtualenv hackery. Will be deprecated soon.
export PATH=:/usr/local/bin:$PATH

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2

NAME=$($BIN_DIR/detect $BUILD_DIR)


indent() {
  RE="s/^/       /"
  [ $(uname) == "Darwin" ] && sed -l "$RE" || sed -u "$RE"
}

# Copy artifacts out of cache.
mkdir -p $CACHE_DIR
cp -R $CACHE_DIR/* . &> /dev/null || true

# Create virtualenv. Rebuild if corrupt.
echo "-----> Running bootstrap.py"
python bin/buildout

# Activate the virtualenv.
echo "-----> Running buildout"
bin/buildout


# Store new artifacts in cache.
rm -rf $CACHE_DIR/*
cp -R * $CACHE_DIR/

